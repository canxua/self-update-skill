# Self-Update Skill 决策路径流程图

## 主流程

```
用户输入: "/自更新" 或 "帮我自更新xxx skill"
                │
                ▼
┌─────────────────────────────────────────┐
│  Step 1: Skill 触发判断                   │
│  检查 description 中的触发词              │
│  ✓ "/自更新"                             │
│  ✓ "自更新" / "更新skill"                │
│  ✓ "优化skill" / "改进skill"             │
│  → 匹配 self-update skill                │
└─────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────┐
│  Step 2: 上下文分析                       │
│  扫描当前会话历史                          │
│  ✓ 识别使用过的skills                     │
│  ✓ 收集执行结果                           │
│  ✓ 提取用户反馈                           │
│  ✓ 记录遇到的问题                         │
│  → 生成分析报告                           │
└─────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────┐
│  Step 3: 经验提取                         │
│  从上下文中提取可优化点                    │
│  ✓ 成功模式 - 值得固化的做法               │
│  ✓ 失败教训 - 需要预防的问题               │
│  ✓ 边界情况 - 新发现的场景                │
│  ✓ 效率改进 - 可简化的步骤                │
│  → 整理经验清单                           │
└─────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────┐
│  Step 4: 目录结构检查（必须）              │
│  检查目标skill的目录组织                   │
│  ✓ 根目录只有 SKILL.md + license         │
│  ✓ 参考文档在 references/                 │
│  ✓ 脚本在 scripts/                        │
│  ✓ 资源在 assets/                         │
│  → 生成结构优化建议                        │
└─────────────────────────────────────────┘
                │
        ┌───────┴───────┐
        ▼               ▼
  [结构不规范]       [结构正常]
        │               │
        ▼               │
┌─────────────────┐     │
│ 记录需要移动的   │     │
│ 文件和目标位置   │     │
└─────────────────┘     │
        │               │
        └───────┬───────┘
                ▼
┌─────────────────────────────────────────┐
│  Step 5: 渐进式加载检查（必须）            │
│  检查内容是否按需分层                      │
│  ✓ description 包含所有触发词             │
│  ✓ SKILL.md < 500 行                     │
│  ✓ 详细内容在 references/                 │
│  ✓ 脚本可独立执行                         │
│  → 生成分层优化建议                        │
└─────────────────────────────────────────┘
                │
        ┌───────┴───────┐
        ▼               ▼
   [需要优化]        [已优化]
        │               │
        ▼               │
┌─────────────────┐     │
│ 记录需要拆分的   │     │
│ 内容和目标文件   │     │
└─────────────────┘     │
        │               │
        └───────┬───────┘
                ▼
┌─────────────────────────────────────────┐
│  Step 6: 优化建议汇总                     │
│  整合所有检查结果                          │
│  ✓ 经验优化建议                           │
│  ✓ 目录结构建议                           │
│  ✓ 渐进式加载建议                         │
│  ✓ 流程图更新建议                         │
│  → 生成完整优化方案                        │
└─────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────┐
│  Step 7: 用户确认                         │
│  展示分析结果和优化建议                    │
│  → 等待用户确认                           │
└─────────────────────────────────────────┘
                │
        ┌───────┴───────┐
        ▼               ▼
   [用户确认]        [用户拒绝]
        │               │
        ▼               ▼
   继续执行          结束流程
        │
        ▼
┌─────────────────────────────────────────┐
│  Step 8: 执行更新                         │
│  1. 重组目录结构（如需要）                 │
│  2. 移动文件到正确位置                     │
│  3. 更新SKILL.md内容                      │
│  4. 拆分内容到references/（如需要）        │
│  5. 验证更新后的格式                       │
│  → 完成主要更新                           │
└─────────────────────────────────────────┘
                │
                ▼
┌─────────────────────────────────────────┐
│  Step 9: 流程图维护（必须）                │
│  检查 references/decision-flow.md        │
└─────────────────────────────────────────┘
                │
        ┌───────┴───────┐
        ▼               ▼
   [不存在]          [已存在]
        │               │
        ▼               ▼
┌─────────────────┐ ┌─────────────────────┐
│ 必须创建流程图   │ │ 检查流程是否有变更    │
│ （无论流程是否   │ └─────────────────────┘
│  有变更）        │         │
└─────────────────┘    ┌────┴────┐
        │              ▼         ▼
        │         [有变更]   [无变更]
        │              │         │
        │              ▼         ▼
        │         更新流程图   跳过更新
        │              │         │
        └──────┬───────┴─────────┘
               ▼
┌─────────────────────────────────────────┐
│  Step 10: 结果展示                        │
│  ✓ 展示目录结构变更                        │
│  ✓ 展示SKILL.md修改内容                   │
│  ✓ 展示渐进式加载优化                      │
│  ✓ 展示流程图更新状态                      │
│  ✓ 提供测试验证建议                       │
│  → 自更新完成                             │
└─────────────────────────────────────────┘
```

## 目录结构检查子流程

```
进入目录结构检查
        │
        ▼
┌─────────────────────────────────────────┐
│  列出目标skill目录下所有文件               │
└─────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────┐
│  检查根目录文件                           │
│  允许: SKILL.md, license.txt             │
│  禁止: 其他 .md, .mmd, .svg 等           │
└─────────────────────────────────────────┘
        │
   ┌────┴────┐
   ▼         ▼
[有违规]   [无违规]
   │         │
   ▼         │
┌─────────────────────────────────────────┐
│  分类违规文件                             │
│  ✓ .md 文档 → references/                │
│  ✓ .mmd 流程图 → references/             │
│  ✓ .svg/.png 图片 → assets/              │
│  ✓ .py/.ps1 脚本 → scripts/              │
└─────────────────────────────────────────┘
   │         │
   └────┬────┘
        ▼
┌─────────────────────────────────────────┐
│  检查子目录命名                           │
│  允许: references/, scripts/, assets/    │
│  禁止: docs/, examples/, test/ 等        │
│  → 生成目录重组建议                        │
└─────────────────────────────────────────┘
```

## 渐进式加载检查子流程

```
进入渐进式加载检查
        │
        ▼
┌─────────────────────────────────────────┐
│  Level 1 检查: description               │
│  ✓ 是否包含所有触发关键词                  │
│  ✓ 是否说明skill用途                      │
│  ✓ 长度是否适中 (~100词)                  │
└─────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────┐
│  Level 2 检查: SKILL.md body             │
│  ✓ 行数是否 < 500                        │
│  ✓ 是否只包含核心流程                      │
│  ✓ 详细内容是否引用到 references/          │
└─────────────────────────────────────────┘
        │
   ┌────┴────┐
   ▼         ▼
[超过500行]  [正常]
   │         │
   ▼         │
┌─────────────────────────────────────────┐
│  识别可拆分内容                           │
│  ✓ 详细示例 → references/examples.md     │
│  ✓ API参考 → references/api.md          │
│  ✓ 配置说明 → references/config.md       │
└─────────────────────────────────────────┘
   │         │
   └────┬────┘
        ▼
┌─────────────────────────────────────────┐
│  Level 3 检查: references/               │
│  ✓ 是否有目录索引                         │
│  ✓ 大文件是否有TOC                        │
│  ✓ 是否从SKILL.md正确引用                 │
└─────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────┐
│  Level 4 检查: scripts/                  │
│  ✓ 脚本是否可独立执行                      │
│  ✓ 是否避免了重复代码                      │
│  → 生成渐进式加载优化建议                   │
└─────────────────────────────────────────┘
```

## 流程图格式规范

### 基本元素

| 元素 | 用途 | 示例 |
|------|------|------|
| `│` `▼` | 流程方向 | 垂直流向 |
| `┌─┐` `└─┘` | 步骤边框 | 包围步骤内容 |
| `Step N:` | 步骤编号 | Step 1: 触发判断 |
| `✓` | 检查项 | ✓ 条件成立 |
| `→` | 结果指向 | → 执行下一步 |
| `[分支]` | 条件分支 | [是] / [否] |

### 分支语法

```
        │
   ┌────┴────┐
   ▼         ▼
[条件A]   [条件B]
   │         │
   ▼         ▼
处理A      处理B
   │         │
   └────┬────┘
        ▼
   [汇合继续]
```
